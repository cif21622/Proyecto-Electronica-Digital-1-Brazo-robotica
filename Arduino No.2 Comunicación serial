#include <Servo.h>
#include <EEPROM.h>

Servo servos[4];
int ultimaPosicion[4] = {0, 0, 0, 0};
bool guardarPosiciones = false;

void setup() {
  for (int i = 0; i < 4; i++) {
    servos[i].attach(8 + i);
  }

  Serial.begin(9600);

  pinMode(2, INPUT_PULLUP);
  pinMode(3, INPUT_PULLUP);
  pinMode(4, INPUT_PULLUP);
  pinMode(5, INPUT_PULLUP);
  pinMode(6, INPUT_PULLUP);

  EEPROM.get(0, ultimaPosicion);
}

void loop() {
  if (Serial.available() >= 4) {
    for (int i = 0; i < 4; i++) {
      int pos = Serial.read();

      if (pos == 255) {
        guardarPosiciones = !guardarPosiciones;
        if (guardarPosiciones) {
          EEPROM.put(0, ultimaPosicion);
        } else {
          EEPROM.get(0, ultimaPosicion);
          for (int j = 0; j < 4; j++) {
            servos[j].write(ultimaPosicion[j]);
          }
        }
      } else if (pos >= 10 && pos <= 150) {
        servos[i].write(pos);
        ultimaPosicion[i] = pos;
      }
    }
  }
}

ISR(PCINT2_vect) {
  byte currentPinDState = PIND;

  if (bitRead(currentPinDState, 2) && !bitRead(lastPinDState, 2)) {
    servos[0].write(135);
  }

  if (!bitRead(currentPinDState, 3) && bitRead(lastPinDState, 3)) {
    servos[1].write(90);
  }

  if (bitRead(currentPinDState, 4) && !bitRead(lastPinDState, 4)) {
    servos[2].write(45);
  }
    }

  lastPinDState = currentPinDState;
}
