#include <Servo.h>
#include <EEPROM.h>

Servo servo1;
Servo servo2;
Servo servo3;
Servo servo4;

int ultimaPosicion[4] = {0, 0, 0, 0};
bool guardarPosiciones = false;

void setup() {
  Serial.begin(9600);

  servo1.attach(8);
  servo2.attach(9);
  servo3.attach(10);
  servo4.attach(11);
}

void loop() {
  if (Serial.available() >= 4) {
    for (int i = 0; i < 4; i++) {
      int pos = Serial.read();

      if (pos == 255) {
        guardarPosiciones = !guardarPosiciones;
        if (guardarPosiciones) {
          // Si se ha recibido el código especial, guardamos las posiciones actuales
          for (int j = 0; j < 4; j++) {
            int posGuardada = ultimaPosicion[j];
            EEPROM.put(j * sizeof(int), posGuardada);
          }
        } else {
          // Si se ha recibido el código especial nuevamente, recuperamos las posiciones guardadas
          for (int j = 0; j < 4; j++) {
            int posGuardada;
            EEPROM.get(j * sizeof(int), posGuardada);
            switch(j) {
              case 0: servo1.write(posGuardada); break;
              case 1: servo2.write(posGuardada); break;
              case 2: servo3.write(posGuardada); break;
              case 3: servo4.write(posGuardada); break;
            }
            ultimaPosicion[j] = posGuardada;
          }
        }
      } else if (pos >= 10 && pos <= 150) {
        switch (i) {
          case 0: servo1.write(pos); break;
          case 1: servo2.write(pos); break;
          case 2: servo3.write(pos); break;
          case 3: servo4.write(pos); break;
        }
        ultimaPosicion[i] = pos;
      }
    }
  }
}
